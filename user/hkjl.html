<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no, email=no" />
	<title>聚车金融</title>
	<link href="../css/mui.min.css" rel="stylesheet"/>     
	<link href="../css/iphone.css" rel="stylesheet"/>
</head>
<body>

<div class="mui-content">
	<div class="dhk">
		<div class="hkjl-name">
				待回款0笔 <span>共计：<font class="hkjl-money">0.00</font>元</span>
		</div>
		<ul class="mui-table-view hkjl-cent">
			 
	         
		</ul>
	</div>
	
	<div class="yhk">
		<div class="hkjl-name">
				已回款0笔<span>共计：0.00元</span>
		</div>
		<ul class="mui-table-view hkjl-cent">
			 
		</ul>
	</div>
</div>			

<script src="../js/jquery-1.11.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/template.js"></script>
<script src="../js/template.function.js"></script>
<script src="../js/api.js"></script>

<script type="text/javascript" charset="utf-8">
	
	mui.init();
		
	mui.plusReady(function(){
			
		request = {'borrow_status':3,'user_id':user.uid(),'order':'repay_time','epage':10000};
		
		borrow.GetRecoverList({'request':request},function(res){
			//console.log(JSON.stringify(res))
			dhkcount=0;
			dhksum=0.00;
			yhkcount=0;
			yhksum=0.00;
			$(res.list).each(function(i,e){
				
				if(e.recover_status==1){
					yhkcount++;
					console.log(e.recover_capital)
					yhksum=yhksum+parseFloat(e.recover_capital);
					$('.yhk .mui-table-view').append(
						'<li class="mui-table-view-cell item" borrow_nid="'+e.borrow_nid+'" has_repay="'+e.recover_recover_account_yes+'">'+
						 	'<i class="hkjl-tubiao"></i>'+
						 	 getLocalTime(e.recover_time) +
						 	'<span class="hkjl-dai">已回款</span>'+
						 	'<span class="hkjl-right">'+e.recover_capital+'<font class="hkjl-yuan">元</font>	</span>'+
						 	'<p class="hkjl-tittle">'+e.borrow_name+'</p>'+
						 '</li>'
					)
				}
				else{
					dhkcount++;
					dhksum=dhksum+parseFloat(e.recover_capital);
					$('.dhk .mui-table-view').append(
						'<li class="mui-table-view-cell item" borrow_nid="'+e.borrow_nid+'" has_repay="'+e.recover_recover_account_yes+'">'+
						 	'<i class="hkjl-tubiao"></i>'+
						 	 getLocalTime(e.recover_time) +
						 	'<span class="hkjl-dai">待回款</span>'+
						 	'<span class="hkjl-money hkjl-right">'+e.recover_capital+'<font class="hkjl-yuan">元</font>	</span>'+
						 	'<p class="hkjl-tittle">'+e.borrow_name+'</p>'+
						 '</li>'
					)
					
				}
			})
			
			
			if(yhkcount){
				yhksum=getFloatStr(yhksum)
				$('.yhk .hkjl-name').html(
					'已回款'+yhkcount+'笔<span>共计：'+yhksum+'元</span>'
				)
			}
			else{
				$('.yhk .mui-table-view').append(
					'<li class="mui-table-view-cell">'+
					 	'<i class="hkjl-tubiao"></i>'+
					 	 '暂无记录' +
					 '</li>'
				)
			}
			if(dhkcount){
				dhksum=getFloatStr(dhksum)
				$('.dhk .hkjl-name').html(
					'待回款'+dhkcount+'笔 <span>共计：<font class="hkjl-money">'+dhksum+'</font>元</span>'
				)
			}
			else{
				$('.dhk .mui-table-view').append(
					'<li class="mui-table-view-cell">'+
					 	'<i class="hkjl-tubiao"></i>'+
					 	 '暂无记录' +
					 '</li>'
				)
			}
			
			
			if(res.total == 0){
				html = '<li class="mui-table-view-cell">没有记录</li>';
				
				
			}
		});
		
		var _clicked = false;
			mui(".mui-content").on('tap', 'li.item', function(e){
				if(!_clicked) { _clicked = true; } else { return false; }
						e.preventDefault();
						var borrow_nid = this.getAttribute('borrow_nid');
						var data = {'article_id': borrow_nid};
						var has_repay = this.getAttribute('has_repay');
						if(has_repay>0){
							
							var pshow = plus.webview.create('../pshow_repay.html','pshow-repay');
							pshow.show("slide-in-right",100);
							_clicked = false;
							
							
						}
						else{
							var pshow = plus.webview.create('../pshow.html','pshow-borrow',{},data);
							pshow.addEventListener('loaded',function(){
								mui.fire(pshow,"mui.view.show",data);
								pshow.show("slide-in-right",100);
								_clicked = false;
							});
						}
			})
	})
	
	function getLocalTime(nS) {     
       return new Date(parseInt(nS) * 1000).toLocaleString().replace(/年|月/g, "-").replace(/日/g, "").replace('GMT+8', "");      
    }
	
	//将传入数据转换为字符串,并清除字符串中非数字与.的字符  
    //按数字格式补全字符串  
	var getFloatStr = function(num){
        num += '';  
        num = num.replace(/[^0-9|\.]/g, ''); //清除字符串中的非数字非.字符  
        
        if(/^0+/) //清除字符串开头的0  
            num = num.replace(/^0+/, '');  
        if(!/\./.test(num)) //为整数字符串在末尾添加.00  
            num += '.00';  
        if(/^\./.test(num)) //字符以.开头时,在开头添加0  
            num = '0' + num;  
        num += '00';        //在字符串末尾补零  
        num = num.match(/\d+\.\d{2}/)[0];  
        return num;
    };
</script>
                       
</body>
</html>