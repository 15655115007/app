<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no, email=no" />
<title>聚车金融</title>
<link href="css/css.css" rel="stylesheet" type="text/css" />
<link href="css/mui.min.css" rel="stylesheet"/>
<link href="css/layer.css" rel="stylesheet"/>
<link href="css/mylayer.css" rel="stylesheet"/>

</head>
    <style type="text/css">
.header{
	width:100%;
	height:45px;
	background:#fff;
	text-align:center;
	font-size:0px;
	line-height:0px;
	position:fixed;
	z-index:999;
	left:0;
	top:0;
	b-webkit-box-sizing:border-box;
	-o-box-sizing:border-box;
	-ms-box-sizing:border-box;
	box-sizing:border-box;
	}
.header:after{
	width:100%;
	height:1px;
	position:absolute;
	left:0;
	bottom:0;
	background:#e6e5e5;
	content:"";
	font-size:0;
	}
header .mui-icon { color: #999; font-size: 14px; }
header .mui-title { color: #333; }
    	#main-box img { max-width: 100%;}
    	
.mui-loader { color: #999; line-height: 20px; font-size: 12px; padding-top: 50px; }

.mui-table-view {}
.mui-table-view:after,.mui-table-view:before { height: 0px; }
.mui-table-view-cell:after { left: 0px; }
.mui-table-view-cell { color: #666666; font-size: 12px; }

.mui-table-view-cell .dsp { right: 80px; position: absolute; }
.mui-table-view-cell i { right: 50px; top: 10px; position: absolute; }

.mui-card { border: 0; margin: 5px 0; }

.mui-input-group .mui-input-row { color: #666666; font-size: 12px; }
.mui-input-group:after,.mui-input-group:before { height: 0px; background: transparent; }
.mui-input-group .mui-input-row:after { left: 0; }
.mui-input-group .mui-input-row i { right: 50px; top: 10px; position: absolute; }
.mui-input-group .mui-input-row  .dsp { right: 80px; position: absolute; }
.moneyfont{ font-size:16px; font-weight:bold;color:#f13f3f;}

			.mui-popover {
				height: 300px;
			}
			.aleTelNum{
				margin-top:-10px;
			}
			.aleTelPri{
				height:50px;
				line-height: 50px;
			}
			.layermend {
				 display: ;
			}
			.layer-wjmm{
				margin-bottom: 20px;
			}
    </style>
<body>
<header class="mui-bar mui-bar-nav header">
	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	<a id="top_right_btn" class="mui-pull-right" style="display: none;"></a>
	<h1 id="title" class="mui-title">投资产品</h1>
</header>
		<!--侧滑菜单容器-->
		<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable" style="margin-top: 40px;">
			<!--菜单部分-->
			<aside id="offCanvasSide" class="mui-off-canvas-right" style="width: 50%; background: #fff;">
				<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
					<div class="mui-scroll" style="padding-bottom: 45px;">	
						<!--<button id="offCanvasHide" type="button" class="mui-btn mui-btn-block" style="padding: 5px 20px;">关闭</button>-->
						<div class="title mui-btn-danger" style="margin-bottom: 10px; line-height: 50px; text-align: center; color: #fff;">我的红包</div>
						<ul class="mui-table-view" id="hongbaolist">
						</ul>
					</div>
				</div>
			</aside>
			<div class="mui-inner-wrap">
				<div id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper">
					<div class="mui-scroll">

<input type="hidden" name="borrow_nid" id="borrow_nid" value="0" />
<input type="hidden" name="borrow_apr" id="borrow_apr" value="0" />
<input type="hidden" name="borrow_period" id="borrow_period" value="0" />
<input type="hidden" name="borrow_style" id="borrow_style" value="" />
<div class="title-bt" id="ktje"></div>
<div id="borrow_account_wait" style=" display:none;"></div>
<div class="box plr10 btline">
<div class="wytz" style=" clear: both;  height:38px; padding: 0 2em 1em 5em;">
<span class="name">我要投资</span>
<span class="unit">元</span>
<div class="link"><input type="number" pattern="[0-9]*" id="money" name="money" value="" /> &nbsp;<button type="button" class="qetx-qetz" id="qetx">全额投资</button></div>

</div>
<div class="wytz-counts">预估收益 <span class="c5" id="span_borrow_sy">0.00</span> 元</div>
</div>

<div class="title-bt">支付信息</div>
		<div class="box plr10 btline">
		    <ul class="mui-table-view mui-table-view-striped mui-table-view-condensed">
		 
		        <li class="mui-table-view-cell">
		            <div class="mui-table">
		                <div class="mui-table-cell mui-col-xs-8">
		                	<span class="name">余额</span>
		                </div>
		                <div class="mui-table-cell mui-col-xs-4 mui-text-right">
		                    <span class="moneyfont" id="balance">0.00元</span>
		                </div>
		            </div>
		        </li>
		               <li class="mui-table-view-cell" id="hongbao-offCanvas">
		            <div class="mui-table">
		                <div class="mui-table-cell mui-col-xs-8">
		                	<span class="name">红包</span>
		                </div>
		                <div class="mui-table-cell mui-col-xs-4 mui-text-right">
		                    <span id="hongbao">未选择</span>
		                    <input type="hidden" name="hmoney" id="hmoney" value="0" />
		                </div>
		            </div>
		        </li>
		    </ul>
		</div>
<div class="exit-opn"><button class="btn" id="btn_submit">确认去支付</button></div>
					</div>
				</div>
				<!-- off-canvas backdrop -->
				<div class="mui-off-canvas-backdrop"></div>
			</div>
		</div>
</div>


<script type="text/html" id="tpl-hongbao-item">
		<li class="mui-table-view-cell">
			<a class="mui-navigate-right" data-value="0" data-id='0' data-money='0'>
				不使用红包
			</a>
		</li>
	{{each list as $item i}}
		<li class="mui-table-view-cell">
			<a class="mui-navigate-right" data-value="{{$item.id}}-{{$item.money}}" data-id='{{$item.id}}' data-money='{{$item.money}}'>
				{{$item.money}}元红包 <!--{{$item.tmoney}}-->
			</a>
		</li>
	{{/each}}
</script>
<script src="js/jquery-1.11.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/layer.js"></script>	
<script src="js/mui.min.js"></script>
<script type="text/javascript" src="js/jQuery.md5.js" ></script>
<script src="js/common.js"></script>
<script src="js/api.js" type="text/javascript" charset="utf-8"></script>
<script src="js/template.js" type="text/javascript" charset="utf-8"></script>
<script src="js/template.function.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" charset="utf-8">
  	mui.init({swipeBack: false});
  	/****自动获取焦点弹窗native.js****/
  	var nativeWebview, imm, InputMethodManager;
	var initNativeObjects = function() {
	    if (mui.os.android) {
	        var main = plus.android.runtimeMainActivity();
	        var Context = plus.android.importClass("android.content.Context");
	        InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
	        imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
	    } else {
	        nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
	    }
	};
	var showSoftInput = function() {
		var nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
	    if (mui.os.android) {
	    	//强制当前webview获得焦点
	        plus.android.importClass(nativeWebview);
	        nativeWebview.requestFocus();
	        imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
	    } else {
	        nativeWebview.plusCallMethod({
	            "setKeyboardDisplayRequiresUserAction": false
	        });
	    }
	    setTimeout(function() {
	       //此处可写具体逻辑设置获取焦点的input
	       var inputElem = document.querySelector('#money');
	              inputElem.focus(); 
	    }, 300);
	};
	//弹窗软键盘
	var showTcInput = function() {
		var nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
	    if (mui.os.android) {
	    	//强制当前webview获得焦点
	        plus.android.importClass(nativeWebview);
	        nativeWebview.requestFocus();
	        imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
	    } else {
	        nativeWebview.plusCallMethod({
	            "setKeyboardDisplayRequiresUserAction": false
	        });
	    }
	    setTimeout(function() {
	       //此处可写具体逻辑设置获取焦点的input
	       var inputElem = document.querySelector('.pwd-input');
	              inputElem.focus(); 
	    }, 400);
	};
	
	mui.plusReady(function() {
	    initNativeObjects();
	    showSoftInput();
	});
  	
  	
</script>

<!--创建可投金额模板-->
<script type="text/html" id="tpl2">
{{if borrow.borrow_account_wait >'100'}}
可投资金额：<span class="c5" id="span_borrow_account">100~{{borrow.borrow_account_wait}}</span>元
{{else}}
可投资金额：<span class="c5" id="span_borrow_account">{{borrow.borrow_account_wait}}</span>元
{{/if}}
</script>

<script type="text/javascript">
	mui.init({
		beforeback: function(){
				//获得a界面的webview
				//var thisIndex= plus.webview.getWebviewById('pshow.html');
				var thisIndex= plus.webview.currentWebview().opener();
//				//触发a的自定义事件（refresh）,从而进行数据刷新
				mui.fire(thisIndex,'refresh');
				//返回true，继续页面关闭逻辑
				return true;
			}
	})
	mui.plusReady(function(){
		/**********忘记密码页面跳转**********/
		$(document).on('tap','#wjmm',function(e){
			e.preventDefault();
			layer.close(index)
			href=$(this).attr('data-href');
			inittemplate = getTemplate('template', 'template.html');
			//获得共用父模板
			var headerWebview = inittemplate.header;
				//获得共用子webview
			var contentWebview = inittemplate.content;
			contentWebview.loadURL(href);
			mui.fire(headerWebview, 'updateHeader', {
				title: '修改交易密码',
				showMenu: false
			});
			mui.fire(headerWebview, 'loading');
			headerWebview.show('slide-in-right', 150);
		});
		//		/*******支付页面返回刷新*******/
		document.addEventListener('ljback',function(){
			plus.webview.currentWebview().reload(true)
		})
		
		request = {'user_id':user.uid()};
		account.GetOne({'request':request},function(res){
			console.log(JSON.stringify(res));
//			$('#total').html(res.total);			
			$('#balance').html(res.balance);
//			$('#await').html(res.await);
//			$('#income').html(res.income);
		})
			hbrequest = {};
			hbrequest = {'user_id': user.uid()};
			hbrequest.status = 1;
		user.GetHongbao({'request':hbrequest},function(res){
//			console.log(JSON.stringify(res));
				
			var html = template('tpl-hongbao-item',res);
			document.getElementById("hongbaolist").innerHTML = html;
//			$("#hongbaolist").html(html);
		})
		

		
		mui("#hongbaolist").on('tap','a', function(e){
			$("#hmoney").val(this.getAttribute('data-value'));
			$("#hongbao").html(this.innerText);
			offCanvasWrapper.offCanvas('close');
		})
		
		
		document.getElementById("hongbao-offCanvas").addEventListener("tap",function(e){
			e.stopPropagation();
			offCanvasWrapper.offCanvas('show');	
		})

		
		document.getElementById("btn_submit").addEventListener('tap',function(e){
			
			var borrow_nid    = $("#borrow_nid").val();
			var borrow_apr    = $("#borrow_apr").val();
			var borrow_period = $("#borrow_period").val();
			var borrow_style  = $("#borrow_style").val();
			var money  = $("#money").val();
			var hmoney = $("#hmoney").val();
			var hongbao;
			if(hmoney==0){
				hongbao="";
			}else{
				hongbao="（含"+hmoney.substr(6)+"元红包）"
			}
			request = {};
			request.borrow_nid = borrow_nid;
			request.borrow_apr = borrow_apr;
			request.borrow_period = borrow_period;
			request.borrow_style = borrow_style;
			request.money = money;
			request.user_id = user.uid();
			request.hmoney = hmoney;
			// 红包
			request.contents = '';
			
			if(money == ""){
				
				//调用getdata()
				plus.nativeUI.alert('请输入投资金额！',function(){
					getdata(ljdata) 
				});
				return false;
			}
			plus.nativeUI.showWaiting();
			
			user.getInfo(function(res){
//						
				if(res){
					if(parseFloat(res.balance)<parseFloat(money)){
						var btnArray = ['取消','确定'];
						mui.confirm('您的余额不足，请充值','', btnArray, function(e) {
							if (e.index == 1) {
								//充值界面			
											var	recharge=plus.webview.create('w_recharge.html','w_recharge.html',{'popGesture':'close'});
											setTimeout(function(){
												recharge.show("slide-in-right",100);
											},50);
											
											recharge.addEventListener('loaded',function(){
												mui.fire(recharge,'recharge',{
													sale_price:sale_price
												});
											});
											return false;
										} else {
											
											return false;
										}
									})
								}
								else{
									pwRequest = {'user_id':user.uid()}; 
									user.GetUsers({'request':pwRequest},function(pw){
										upayWord=pw.paypassword;
									})
									$('.paypassword').val('');
									function closelayer(){
										layer.close(index)
									}
									index =layer.open({
										title: [
									        '交易密码',
											'text-align:center;padding:0px;margin:0;'
									    ],
									    content: '<p class="aleTelNum">投资&nbsp;'+biaoName+'</p><p class="aleTelPri">￥'+money+'.00<span style="font-size:12px">'+hongbao+'</span></p><div class="pwd-box"><input type="tel" maxlength="6" class="pwd-input" id="pwd-input"><div class="fake-box"><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""><input type="password" readonly=""></div></div><div class="layer-wjmm"><a id="wjmm" data-href="wjmmpay.html">忘记交易密码?</a></div>',
									    shadeClose: false,
									    anim:true,
									    success:function(layero, index){
												initNativeObjects();
		   										showTcInput();
		   										var $input = $(".fake-box input");  
										        $("#pwd-input").on("input", function() {  
										            var pwd = $(this).val().trim();  
										            for (var i = 0, len = pwd.length; i < len; i++) {  
										                $input.eq("" + i + "").val(pwd[i]);  
										            }  
										            $input.each(function(){  
										                var index2 = $(this).index();  
										                if (index2 >= len) {  
										                    $(this).val("");  
										                }  
										            });  
										            console.log($(this).val());
										            if (len >=6) {
										            	//paypassword=$(this).val()
										            	console.log("我的密码是："+$(this).val());
												    	paypassword=$.md5($(this).val());
												    	
														if(paypassword==upayWord){
															console.log("密码正确")
															borrow.tender(request,function(res){
															//console.log("9"+JSON.stringify(res));
															plus.nativeUI.showWaiting();
															if(res.status == 1){
																//alert("投标成功");
																	closelayer()
																	plus.nativeUI.closeWaiting();
																	data = {'article_id': borrow_nid};
																	//跳转成功页面
																	var tzcg=mui.openWindow({
																		url:"tzcg.html",
																		id:"tzcg.html",
																		styles:{"aniShow":"slide-in-right","popGesture":"close"},
																		waiting:{"autoShow":false},
																		extras:{
																			money:money,
																			article_id: ljdata,
																			nowtime :new Date().getTime() / 1000
																			
																		}
																	})
																	mui.fire(plus.webview.getWebviewById("tzcg.html"), "mui.view.show",data);
																	
															}else{
																plus.nativeUI.closeWaiting();
																if(res.status == -2){
																	//返回这个页面时调用getdata()
																	//提示余额不足，请充值
											//						alert(res.msg + '-2');
																	plus.nativeUI.alert(res.msg, function(){
											//							mui.fire(plus.webview.currentWebview().opener(), "reload");
																		mui.openWindow({'url':'w_recharge.html','id':'w_recharge.html', 'styles':{'top':'0px'},'show':{'autoShow':false},'waiting':{'autoShow':false}});
																	}, "提示", "充值" );
																}else{
																	closelayer()
																	plus.nativeUI.alert("s"+res.msg,function(){
																		getdata(ljdata)
																		
																	});
																}
															}
														})
															
														}else{
															closelayer()
															mui.toast("交易密码错误")
														}
											    	}
											    })
											}
										})
									}
								}
							});
						});
		document.addEventListener('tap',function(event){
			if(document.activeElement == document.getElementById("money") && event.target.id != 'money'){
				$('#money').blur();
			}
		})
 			//侧滑容器父节点
			var offCanvasWrapper = mui('#offCanvasWrapper');
			 //主界面容器
			var offCanvasInner = offCanvasWrapper[0].querySelector('.mui-inner-wrap');
			 //菜单容器
			var offCanvasSide = document.getElementById("offCanvasSide");
			 //移动效果是否为整体移动
			var moveTogether = false;
			 //侧滑容器的class列表，增加.mui-slide-in即可实现菜单移动、主界面不动的效果；
			 //变换侧滑动画移动效果；
			 
//			document.getElementById('offCanvasShow').addEventListener('tap', function() {
//				offCanvasWrapper.offCanvas('show');
//			});
//			document.getElementById('offCanvasHide').addEventListener('tap', function() {
//				offCanvasWrapper.offCanvas('close');
//			});
			 //主界面和侧滑菜单界面均支持区域滚动；
			mui('#offCanvasSideScroll').scroll();
			mui('#offCanvasContentScroll').scroll();
			 //实现ios平台的侧滑关闭页面；
			if (mui.os.plus && mui.os.ios) {
				offCanvasWrapper[0].addEventListener('shown', function(e) { //菜单显示完成事件
					plus.webview.currentWebview().setStyle({
						'popGesture': 'none'
					});
				});
				offCanvasWrapper[0].addEventListener('hidden', function(e) { //菜单关闭完成事件
					plus.webview.currentWebview().setStyle({
						'popGesture': 'close'
					});
				});
			}
	})
	document.getElementById('qetx').addEventListener('tap',function(){	
			var money = parseInt($("#balance").html());		
			var account_wait = parseInt($("#borrow_account_wait").html());
			var moneyb = parseInt(money/100);		
            var moneyd = moneyb*100;	
			if(money>100){
				if (money>account_wait){				
			        $("#money").val(account_wait);			      
				} else{
			       $("#money").val(moneyd);
			      }
				 				
			}else{
				 mui.alert('您的余额不足100，请充值！', function() {
                    getdata(ljdata)
               });	
			}
			
			var borrow_nid    = $("#borrow_nid").val();
			var borrow_apr    = $("#borrow_apr").val();
			var borrow_period = $("#borrow_period").val();
			var borrow_style  = $("#borrow_style").val();
			var borrow_money  = $("#money").val();
			request = {};
			request.borrow_nid = borrow_nid;
			request.borrow_apr = borrow_apr;
			request.borrow_period = borrow_period;
			request.borrow_style = borrow_style;
			request.money = borrow_money;
			console.log(JSON.stringify(request));
			borrow.sy({'request':request},function(res){
				if(res) {
					$('#span_borrow_sy').html(res);
				}else{
					$('#span_borrow_sy').html("0.00");
				}
			})
			
		})
	
	/*****根据psshow页面传入的监听事件。是、其中传入data中含有borrow_account_wait值*****/
		document.addEventListener("ljtzId",function(e){
			
			console.log(JSON.stringify(e.detail));
			window.scrollTo(0,0);
			var data = e.detail;
			ljdata=data;
			getdata(data);	
		
		},false);

//	
	
		document.addEventListener('mui.view.show',function(e){
			
//			console.log(JSON.stringify(e.detail));
			var id = e.detail.id;//获得传递的参数ID标示
			var borrow_account_wait = e.detail.borrow_account_wait;
			/*1 var account_wait = parseInt(borrow_account_wait);
			console.log("qq"+borrow_account_wait)
			if(parseFloat(borrow_account_wait) >= 100){
				$('#span_borrow_account').html('100 ~ ' + borrow_account_wait);
			}else{
				$('#span_borrow_account').html(borrow_account_wait);
			}
			$('#borrow_account_wait').html(account_wait);*/
			$("#borrow_nid").val(e.detail.borrow_nid);
			$("#borrow_apr").val(e.detail.borrow_apr);
			$("#borrow_period").val(e.detail.borrow_period);
			$("#borrow_style").val(e.detail.borrow_style);

		},false);
		//data如何传？
	function getdata(data){
		var request = data;//含有上个页面传来article_id、id、has_repay的对象
		request.borrow_nid = data.article_id;
		product.detail({"request":request},function(res){
			//
			$('#borrow_account_wait').html(res.borrow.borrow_account_wait);
			//console.log(res.borrow.borrow_account_wait);
			biaoName=res.borrow.name;
			console.log("9"+JSON.stringify(res));
			//console.log(biaoName);
			if(res){
			res.is_login = user.uid();
			res.nowtime = new Date().getTime() / 1000;
			var html = template('tpl2',res);
			$('#ktje').html(html);
			
			}else{
				
			}
			plus.nativeUI.closeWaiting();
			var self = plus.webview.currentWebview();
		})
		
	}
		
		
		/*var back_old = mui.back;
		mui.back = function(){
			plus.webview.currentWebview().opener().evalJS("window.scrollTo(0,0);");
			back_old();
		}*/

$(function(){
    $('#money').keyup(function(){
	var borrow_nid    = $("#borrow_nid").val();
	var borrow_apr    = $("#borrow_apr").val();
	var borrow_period = $("#borrow_period").val();
	var borrow_style  = $("#borrow_style").val();
	var money  = $("#money").val();
	request = {};
	request.borrow_nid = borrow_nid;
	request.borrow_apr = borrow_apr;
	request.borrow_period = borrow_period;
	request.borrow_style = borrow_style;
	request.money = money;
	//console.log(JSON.stringify(request));
		borrow.sy({'request':request},function(res){
			if(res) {
				$('#span_borrow_sy').html(res);
			}else{
				$('#span_borrow_sy').html("0.00");
			}
		})
    });
    
	$("#money").blur(function(){
		if($("#hmoney").val() != 0){
			$("#hmoney").val('0');
			$("#hongbao").html("未选择");
		}
		var hbaomoney = $("#hongbaolist li");
		var moneyvalue = $("#money:text").val();
		if(!isNaN(moneyvalue)){
			hbaomoney.each(function(){
			 var str = $(this).find('a').attr('data-value');
			  strs=str.substr(str.indexOf('-')+1,9);
			 if( (moneyvalue)*(0.01) < 20 ){
			 	if ( (strs) > (moneyvalue)*(0.01) ){
					$(this).hide();
				}else{
					$(this).show();
				}
			 }else{
			 	if ( (strs) > (moneyvalue)*(0.005) ){
					$(this).hide();
				}else{
					$(this).show();
				}
			 }
			});
		}
	});
})
</script>
</body>
</html>